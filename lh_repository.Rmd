---
title:  Explore Life Histories 
output:
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
    collapsed: false
    smooth_scroll: false
    number_sections: false
#runtime: shiny
---


```{r, include=FALSE}

# library(RWordPress)
# options(WordpressLogin = c(pamoore = 'FishIsABish2021!'),
#         WordpressURL = 'https://natureanalytics.ca/xmlrpc.php')
# library(knitr)
# knit2wp('lh_repository.Rmd',
#         title = 'Life History Repository', 
#         action = c("newPage"),
#         publish = TRUE)



library(fishSimGTG)
library(dplyr)
library(here)
library(kableExtra)
library(prettydoc)
library(aws.s3)

#Additional function
space_infoRDS<- function() {
  bucket <- as.character(unlist(stringr::str_split(Sys.getenv("SPACES_BUCKET"), "/", 2))[1])
  #prefix <- as.character(paste0(as.character(unlist(stringr::str_split(Sys.getenv("SPACES_BUCKET"), "/", 2))[-1]), "/", prefix,"/"))

  #Returns NULL if cannot communicate with server
  show_condition <- function(code) {
    tryCatch(code,
             condition = function(c) {
               NULL
             }
    )
  }
 
  space_info<-show_condition(aws.s3::get_bucket_df(bucket =  bucket,
                                      #prefix = prefix,
                                      region = Sys.getenv("SPACES_REGION"),
                                      check_region = FALSE,
                                      key = Sys.getenv("SPACES_ACCESS_KEY"),
                                      secret = Sys.getenv("SPACES_SECRET_KEY"),
                                      base_url = Sys.getenv("SPACES_BASE"),
                                      max = Inf))
 
  if(!is.null(space_info)){
    space_info$Time<-stringr::str_subset(stringr::str_split(space_info$LastModified, "T", simplify=TRUE), "Z")
    space_info$Date<-as.Date(space_info$LastModified)
    space_info$ProjectName<-stringr::str_sub(stringr::str_subset(stringr::str_split(space_info$Key, "/", simplify=TRUE), ".rds"), end=-5L)
  }
 
  return(space_info)
}

 # READ IN FILES FROM DIGITAL OCEAN   
space_getRDS<- function(object) {
 
  object <- as.character(object)
  bucket <- as.character(Sys.getenv("SPACES_BUCKET"))
 
  #Returns NULL if cannot communicate with server
  show_condition <- function(code) {
    tryCatch(code,
             condition = function(c) {
               NULL
             }
    )
  }
  output<-show_condition(
    aws.s3::s3readRDS(object=object,
                      bucket=bucket,
                      region = Sys.getenv("SPACES_REGION"),
                      check_region = FALSE,
                      key = Sys.getenv("SPACES_ACCESS_KEY"),
                      secret = Sys.getenv("SPACES_SECRET_KEY"),
                      base_url = Sys.getenv("SPACES_BASE"))
  )
 
  return(output)
}


grabber <-  lapply(
  X = sort(space_infoRDS()$Key), 
  FUN = function(X){
    space_getRDS(X)
                   })

namesGrabber<- unlist(lapply(
  X = 1:NROW(grabber), function(X){
    grabber[[X]]@speciesName
  }
))

src <- lapply(
  X = order(namesGrabber), 
  FUN = function(X) {
    knitr::knit_expand(
      file = here::here("child", "template.Rmd"), 
      lh = grabber[[X]]
    )
  }
)
```


# About

This repository contains life history information for species of fish, as entered by users of the TNC & Nature Analytics Size Limit Trade-off Tool. These life histories can be used in the tool to estimate spawning potential ratio and fishing yield projected for size limit regulations. 

# Explore Life Histories


`r knitr::knit(text = unlist(src))`





 
